<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venturi Meter Monitoring</title>
    <link rel="manifest" href="/flowsense/manifest.webmanifest">
    <meta name="theme-color" content="#1E274E">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-bg: #151C35;
            --card-bg: #1E274E;
            --text-color: #FFFFFF;
            --accent-blue: #65D8E4;
            --accent-orange: #FF9F45;
            --accent-yellow: #FFD166;
            --accent-red: #EF476F;
            --accent-green: #06D6A0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            padding: 15px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        
        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .last-update {
            font-size: 0.9rem;
            color: #9DA3B4;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .card-title {
            margin-bottom: 15px;
            font-weight: 500;
            font-size: 1rem;
            color: #9DA3B4;
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .card-unit {
            font-size: 1rem;
            vertical-align: super;
            margin-left: 5px;
        }
        
        .card-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: auto;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-text {
            font-size: 0.85rem;
        }
        
        .chart-container {
            flex: 1;
            min-height: 130px;
            position: relative;
        }
        
        .dual-value {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .value-block {
            display: flex;
            flex-direction: column;
        }
        
        .sensor-label {
            font-size: 0.9rem;
            color: #9DA3B4;
            margin-bottom: 5px;
        }
        
        .sensor-value {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .value-unit {
            font-size: 0.9rem;
            vertical-align: super;
            margin-left: 2px;
        }
        
        .chart-dual {
            flex: 1;
            min-height: 130px;
            position: relative;
        }
        
        .dominant-factor {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #9DA3B4;
        }
        
        .gauge-container {
            position: relative;
            width: 100%;
            height: 140px;
            margin: 15px 0;
        }
        
        .gauge-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .gauge-value {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .gauge-label {
            font-size: 0.9rem;
            color: #9DA3B4;
        }
        
        .refresh-button {
            background-color: #2E3755;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
        }
        
        .refresh-button:hover {
            background-color: #3A4674;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            color: #9DA3B4;
            font-size: 0.85rem;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .card-value {
                font-size: 2rem;
            }
        }

        @media (min-width: 768px) {
            .modal {
                top: 50%;
                bottom: auto;
                transform: translate(-50%, -50%) scale(0.9);
                opacity: 0;
                border-radius: 16px;
                max-height: 80vh;
            }
            
            .modal.active {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            
            .modal-drag-handle {
                display: none;
            }
        }
        
        .centered-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .moon-phase-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 120px;
        }
        
        .moon-phase {
            width: 100px;
            height: 100px;
            background-color: var(--accent-yellow);
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        
        .moon-mask {
            position: absolute;
            top: 0;
            right: 0;
            width: 97px;
            height: 100px;
            background-color: var(--card-bg);
            border-radius: 50%;
            transform: translateX(3px);
        }
        
        .diff-value {
            color: var(--accent-blue);
            font-weight: 600;
        }
        
        .flow-value {
            color: var(--accent-green);
            font-weight: 600;
        }
        
        .ratio-value {
            color: var(--accent-yellow);
            font-weight: 600;
        }
        
        .footer-info {
            text-align: center;
            margin-top: 20px;
            color: #9DA3B4;
            font-size: 0.85rem;
        }
        
        /* Loader styling */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--accent-blue);
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Status colors */
        .normal { background-color: var(--accent-green); }
        .warning { background-color: var(--accent-yellow); }
        .alert { background-color: var(--accent-red); }
        .info { background-color: var(--accent-blue); }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            background-color: #1E2746;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            visibility: hidden;
        }
        
        .modal.active {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        
        .modal-header {
            padding: 16px;
            background-color: #2A3655;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
        }
        
        .modal-title {
            margin: 0;
            font-size: 18px;
            color: #FFFFFF;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #9DA3B4;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-content {
            padding: 16px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .modal-drag-handle {
            height: 4px;
            width: 40px;
            background-color: rgba(255, 255, 255, 0.3);
            margin: 8px auto;
            border-radius: 2px;
            cursor: ns-resize;
        }
        
        /* Info button on cards */
        .card-info-button {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: #9DA3B4;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #000;
            color: white;
            padding: 8px;
            z-index: 100;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link" id="skip-link">Skip to main content</a>

    <header role="banner">
        <div class="header-title">
            <h1>Venturi Meter Monitoring</h1>
            <div class="last-update" id="lastUpdate" aria-live="polite">12:09 PM</div>
        </div>
        <button class="refresh-button" id="refreshButton" onclick="fetchData()" aria-label="Refresh data">
            <span id="refreshIcon" aria-hidden="true">↻</span> Refresh
        </button>
    </header>

    <main id="main-content" role="main">
        <div class="dashboard">
            <!-- Pressure 1 Card -->
            <section class="card" aria-labelledby="pressure1-title">
                <h2 class="card-title" id="pressure1-title">Pressure 1</h2>
                <div class="card-value">
                    <span id="pressure1Value" aria-live="polite">0.00</span>
                    <span class="card-unit">Pa</span>
                </div>
                <div class="chart-container">
                    <canvas id="pressure1Chart" aria-label="Pressure 1 over time chart" role="img"></canvas>
                    <div id="pressure1ChartDescription" class="sr-only">Chart showing pressure 1 readings over time</div>
                </div>
                <div class="card-status">
                    <div class="status-indicator normal" id="pressure1Status" aria-hidden="true"></div>
                    <div class="status-text" id="pressure1StatusText" aria-live="polite">Stable</div>
                </div>
                <button class="info-button" aria-label="Show more information about Pressure 1" aria-expanded="false" aria-controls="pressure1InfoModal" onclick="showModalInfo('pressure1')">
                    Info
                </button>
            </section>

            <!-- Pressure 2 Card -->
            <section class="card" aria-labelledby="pressure2-title">
                <h2 class="card-title" id="pressure2-title">Pressure 2</h2>
                <div class="card-value">
                    <span id="pressure2Value" aria-live="polite">0.00</span>
                    <span class="card-unit">Pa</span>
                </div>
                <div class="chart-container">
                    <canvas id="pressure2Chart" aria-label="Pressure 2 over time chart" role="img"></canvas>
                    <div id="pressure2ChartDescription" class="sr-only">Chart showing pressure 2 readings over time</div>
                </div>
                <div class="card-status">
                    <div class="status-indicator normal" id="pressure2Status" aria-hidden="true"></div>
                    <div class="status-text" id="pressure2StatusText" aria-live="polite">Stable</div>
                </div>
                <button class="info-button" aria-label="Show more information about Pressure 2" aria-expanded="false" aria-controls="pressure2InfoModal" onclick="showModalInfo('pressure2')">
                    Info
                </button>
            </section>

            <!-- Differential Pressure Card -->
            <section class="card" aria-labelledby="diffPressure-title">
                <h2 class="card-title" id="diffPressure-title">Differential Pressure</h2>
                <div class="card-value">
                    <span id="diffPressureValue" aria-live="polite">0.00</span>
                    <span class="card-unit">Pa</span>
                </div>
                <div class="chart-container">
                    <canvas id="diffPressureChart" aria-label="Differential pressure over time chart" role="img"></canvas>
                    <div id="diffPressureChartDescription" class="sr-only">Chart showing differential pressure readings over time</div>
                </div>
                <div class="card-status">
                    <div class="status-indicator info" id="diffStatus" aria-hidden="true"></div>
                    <div class="status-text" id="diffStatusText" aria-live="polite">Normal differential</div>
                </div>
                <button class="info-button" aria-label="Show more information about Differential Pressure" aria-expanded="false" aria-controls="diffPressureInfoModal" onclick="showModalInfo('diffPressure')">
                    Info
                </button>
            </section>

            <!-- Flow Rate Card -->
            <section class="card" aria-labelledby="flowRate-title">
                <h2 class="card-title" id="flowRate-title">Flow Rate</h2>
                <div class="card-value">
                    <span id="flowRateValue" aria-live="polite">0.00</span>
                    <span class="card-unit">L/min</span>
                </div>
                <div class="chart-container">
                    <canvas id="flowRateChart" aria-label="Flow rate over time chart" role="img"></canvas>
                    <div id="flowRateChartDescription" class="sr-only">Chart showing flow rate readings over time</div>
                </div>
                <div class="card-status">
                    <div class="status-indicator normal" id="flowStatus" aria-hidden="true"></div>
                    <div class="status-text" id="flowStatusText" aria-live="polite">Normal flow</div>
                </div>
                <button class="info-button" aria-label="Show more information about Flow Rate" aria-expanded="false" aria-controls="flowRateInfoModal" onclick="showModalInfo('flowRate')">
                    Info
                </button>
            </section>

            <!-- Pressure Comparison -->
            <section class="card" aria-labelledby="pressureComp-title">
                <h2 class="card-title" id="pressureComp-title">Pressure Comparison</h2>
                <div class="dual-value">
                    <div class="value-block">
                        <h3 class="sensor-label" id="sensor1Label">Sensor 1</h3>
                        <div class="sensor-value">
                            <span id="compPressure1" aria-live="polite" aria-labelledby="sensor1Label">0.00</span>
                            <span class="value-unit">Pa</span>
                        </div>
                    </div>
                    <div class="value-block">
                        <h3 class="sensor-label" id="sensor2Label">Sensor 2</h3>
                        <div class="sensor-value">
                            <span id="compPressure2" aria-live="polite" aria-labelledby="sensor2Label">0.00</span>
                            <span class="value-unit">Pa</span>
                        </div>
                    </div>
                </div>
                <div class="chart-dual">
                    <canvas id="pressureCompChart" aria-label="Pressure comparison chart" role="img"></canvas>
                    <div id="pressureCompChartDescription" class="sr-only">Chart comparing readings from pressure sensors 1 and 2</div>
                </div>
                <div class="dominant-factor">
                    Difference: <span class="diff-value" id="pressureDiffText" aria-live="polite">0.00 Pa</span>
                </div>
                <button class="info-button" aria-label="Show more information about Pressure Comparison" aria-expanded="false" aria-controls="pressureCompInfoModal" onclick="showModalInfo('pressureComp')">
                    Info
                </button>
            </section>

            <!-- Flow Rate Gauge -->
            <section class="card" aria-labelledby="flowGauge-title">
                <h2 class="card-title" id="flowGauge-title">Flow Rate Gauge</h2>
                <div class="gauge-container">
                    <canvas id="flowGauge" aria-label="Flow rate gauge visualization" role="img"></canvas>
                    <div id="flowGaugeDescription" class="sr-only">Gauge showing current flow rate relative to min and max values</div>
                    <div class="gauge-center">
                        <div class="gauge-value" id="gaugeFlowValue" aria-live="polite">0.00</div>
                        <div class="gauge-label">L/min</div>
                    </div>
                </div>
                <div class="info-row">
                    <span id="minFlowLabel">Min: <span id="minFlow" aria-live="polite">0.00</span> L/min</span>
                    <span id="maxFlowLabel">Max: <span id="maxFlow" aria-live="polite">10.00</span> L/min</span>
                </div>
                <button class="info-button" aria-label="Show more information about Flow Rate Gauge" aria-expanded="false" aria-controls="flowGaugeInfoModal" onclick="showModalInfo('flowGauge')">
                    Info
                </button>
            </section>

            <!-- Efficiency Card -->
            <section class="card" aria-labelledby="efficiency-title">
                <h2 class="card-title" id="efficiency-title">Venturi Efficiency</h2>
                <div class="gauge-container">
                    <canvas id="efficiencyGauge" aria-label="Venturi efficiency gauge visualization" role="img"></canvas>
                    <div id="efficiencyGaugeDescription" class="sr-only">Gauge showing current Venturi efficiency percentage</div>
                    <div class="gauge-center">
                        <div class="gauge-value" id="efficiencyValue" aria-live="polite">0</div>
                        <div class="gauge-label">%</div>
                    </div>
                </div>
                <div class="info-row">
                    <span>Calculated from pressure recovery</span>
                </div>
                <button class="info-button" aria-label="Show more information about Venturi Efficiency" aria-expanded="false" aria-controls="efficiencyInfoModal" onclick="showModalInfo('efficiency')">
                    Info
                </button>
            </section>

            <!-- Reynolds Number -->
            <section class="card" aria-labelledby="reynolds-title">
                <h2 class="card-title" id="reynolds-title">Reynolds Number</h2>
                <div class="card-value">
                    <span id="reynoldsValue" aria-live="polite">0</span>
                </div>
                <div class="chart-container">
                    <canvas id="reynoldsChart" aria-label="Reynolds number over time chart" role="img"></canvas>
                    <div id="reynoldsChartDescription" class="sr-only">Chart showing Reynolds number readings over time</div>
                </div>
                <div class="card-status">
                    <div class="status-indicator info" id="flowTypeStatus" aria-hidden="true"></div>
                    <div class="status-text" id="flowTypeText" aria-live="polite">Laminar Flow</div>
                </div>
                <button class="info-button" aria-label="Show more information about Reynolds Number" aria-expanded="false" aria-controls="reynoldsInfoModal" onclick="showModalInfo('reynolds')">
                    Info
                </button>
            </section>

            <!-- System Status -->
            <section class="card" aria-labelledby="systemStatus-title">
                <h2 class="card-title" id="systemStatus-title">System Status</h2>
                <div class="dual-value">
                    <div class="value-block">
                        <h3 class="sensor-label" id="sensor1StatusLabel">Sensor 1</h3>
                        <div class="sensor-value">
                            <span id="sensor1Status" aria-live="polite" aria-labelledby="sensor1StatusLabel">OK</span>
                        </div>
                    </div>
                    <div class="value-block">
                        <h3 class="sensor-label" id="sensor2StatusLabel">Sensor 2</h3>
                        <div class="sensor-value">
                            <span id="sensor2Status" aria-live="polite" aria-labelledby="sensor2StatusLabel">OK</span>
                        </div>
                    </div>
                </div>
                <div class="info-row" style="margin-top: 20px;">
                    <span id="uptimeLabel">Device Uptime: <span id="uptime" aria-live="polite">0</span> minutes</span>
                </div>
                <div class="info-row">
                    <span id="lastDataTimeLabel">Last Data: <span id="lastDataTime" aria-live="polite">N/A</span></span>
                </div>
                <div class="info-row">
                    <span id="sampleCountLabel">Samples: <span id="sampleCount" aria-live="polite">0</span></span>
                </div>
                <button class="info-button" aria-label="Show more information about System Status" aria-expanded="false" aria-controls="systemStatusInfoModal" onclick="showModalInfo('systemStatus')">
                    Info
                </button>
            </section>

            <!-- Configuration Info -->
            <section class="card" aria-labelledby="config-title">
                <h2 class="card-title" id="config-title">Configuration</h2>
                <dl class="info-list">
                    <div class="info-row">
                        <dt id="venturiTypeLabel">Venturi Type:</dt>
                        <dd id="venturiType" aria-labelledby="venturiTypeLabel">DOUBLE_PIPE</dd>
                    </div>
                    <div class="info-row">
                        <dt id="mainDiameterLabel">Main Pipe Diameter:</dt>
                        <dd id="mainDiameter" aria-labelledby="mainDiameterLabel">20.0 mm</dd>
                    </div>
                    <div class="info-row">
                        <dt id="throatDiameterLabel">Throat Diameter:</dt>
                        <dd id="throatDiameter" aria-labelledby="throatDiameterLabel">10.0 mm</dd>
                    </div>
                    <div class="info-row">
                        <dt id="areaRatioLabel">Area Ratio:</dt>
                        <dd class="ratio-value" id="areaRatio" aria-labelledby="areaRatioLabel">4.00</dd>
                    </div>
                </dl>
                <button class="info-button" aria-label="Show more information about Configuration" aria-expanded="false" aria-controls="configInfoModal" onclick="showModalInfo('config')">
                    Info
                </button>
            </section>
        </div>
    </main>

    <!-- Modal for additional information -->
    <div class="modal-overlay" id="modalOverlay" role="dialog" aria-labelledby="modalTitle" aria-hidden="true" aria-modal="true"></div>

    <div class="modal" id="infoModal" aria-hidden="true">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Chart Information</h3>
            <button class="modal-close" id="modalClose" aria-label="Close dialog">&times;</button>
        </div>
        <div class="modal-content" id="modalContent" tabindex="0">
            <!-- Content will be inserted here -->
        </div>
        <div class="modal-drag-handle" aria-hidden="true"></div>
    </div>

    <footer role="contentinfo" class="footer-info">
        <p>Venturi Meter Monitoring System | Last Updated: <span id="footerLastUpdate" aria-live="polite">12:09 PM</span></p>
    </footer>

    <script>
        // Initialize charts with empty data
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    display: false
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#9DA3B4',
                        font: {
                            size: 10
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            elements: {
                line: {
                    tension: 0.4
                },
                point: {
                    radius: 0
                }
            },
            animation: {
                duration: 1000
            }
        };

        const commonGaugeOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            circumference: 180,
            rotation: 270,
            cutout: '70%'
        };

        // Initialize colors
        const colors = {
            blue: '#65D8E4',
            orange: '#FF9F45',
            yellow: '#FFD166',
            green: '#06D6A0',
            red: '#EF476F',
            purple: '#9B5DE5'
        };

        // Create empty charts
        let pressure1Chart, pressure2Chart, diffPressureChart, flowRateChart;
        let pressureCompChart, flowGauge, efficiencyGauge, reynoldsChart;

        // Create time labels (last 10 readings)
        const timeLabels = Array(10).fill().map((_, i) => (i + 1).toString());

        // Create empty datasets
        const emptyData = Array(10).fill(null);

        // Initialize all charts
        function initCharts() {
            // Single line charts
            pressure1Chart = createLineChart('pressure1Chart', colors.blue);
            pressure2Chart = createLineChart('pressure2Chart', colors.green);
            diffPressureChart = createLineChart('diffPressureChart', colors.yellow);
            flowRateChart = createLineChart('flowRateChart', colors.orange);
            reynoldsChart = createLineChart('reynoldsChart', colors.purple);
            
            // Comparison chart
            pressureCompChart = new Chart(document.getElementById('pressureCompChart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Pressure 1',
                            data: emptyData,
                            borderColor: colors.blue,
                            backgroundColor: colors.blue + '20',
                            fill: true
                        },
                        {
                            label: 'Pressure 2',
                            data: emptyData,
                            borderColor: colors.green,
                            backgroundColor: colors.green + '20',
                            fill: true
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: '#9DA3B4',
                                boxWidth: 10,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
            
            // Flow Gauge
            flowGauge = new Chart(document.getElementById('flowGauge'), {
                type: 'doughnut',
                data: {
                    labels: ['Flow', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            createGradient(document.getElementById('flowGauge'), colors.blue, colors.green),
                            'rgba(30, 39, 78, 0.3)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: commonGaugeOptions
            });
            
            // Efficiency Gauge
            efficiencyGauge = new Chart(document.getElementById('efficiencyGauge'), {
                type: 'doughnut',
                data: {
                    labels: ['Efficiency', 'Remaining'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: [
                            createGradient(document.getElementById('efficiencyGauge'), colors.yellow, colors.orange),
                            'rgba(30, 39, 78, 0.3)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: commonGaugeOptions
            });
        }

        // Helper function to create a linear gradient for gauges
        function createGradient(ctx, colorStart, colorEnd) {
            const canvas = ctx.getContext('2d');
            const gradient = canvas.createLinearGradient(0, 0, 0, 180);
            gradient.addColorStop(0, colorEnd);
            gradient.addColorStop(1, colorStart);
            return gradient;
        }

        // Helper function to create line charts
        function createLineChart(elementId, color) {
            return new Chart(document.getElementById(elementId), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        data: emptyData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true
                    }]
                },
                options: chartOptions
            });
        }

        // Update chart with new data
        function updateChart(chart, newData) {
            chart.data.datasets[0].data = newData;
            chart.update();
        }

        // Update comparison chart with new data
        function updateCompChart(chart, data1, data2) {
            chart.data.datasets[0].data = data1;
            chart.data.datasets[1].data = data2;
            chart.update();
        }

        // Update gauge chart with new percentage
        function updateGauge(gauge, percentage) {
            gauge.data.datasets[0].data = [percentage, 100 - percentage];
            gauge.update();
        }

        // Sample data for demonstration (will be replaced with actual data)
        let sampleHistoryPressure1 = [100.5, 101.2, 100.8, 101.5, 102.0, 101.8, 101.3, 101.0, 100.7, 101.2];
        let sampleHistoryPressure2 = [80.2, 80.5, 80.1, 79.8, 80.0, 80.4, 80.6, 80.3, 80.1, 79.9];
        let sampleHistoryDiff = sampleHistoryPressure1.map((p1, i) => p1 - sampleHistoryPressure2[i]);
        let sampleHistoryFlow = sampleHistoryDiff.map(diff => Math.sqrt(diff) * 0.8);
        let sampleHistoryReynolds = sampleHistoryFlow.map(flow => flow * 1000);
        
        let dataHistory = {
            pressure1: sampleHistoryPressure1,
            pressure2: sampleHistoryPressure2,
            diffPressure: sampleHistoryDiff,
            flowRate: sampleHistoryFlow,
            reynolds: sampleHistoryReynolds
        };
        
        // Current values
        let currentData = {
            pressure1: 101.2,
            pressure2: 79.9,
            diffPressure: 21.3,
            flowRate: 3.68,
            reynolds: 3680,
            efficiency: 85,
            uptime: 120,
            sampleCount: 350
        };
        
        // Configuration values
        const config = {
            venturiType: "DOUBLE_PIPE",
            mainDiameter: 20.0,
            throatDiameter: 10.0,
            areaRatio: 4.0
        };

        // Update all displayed values
        function updateDisplayedValues() {
            // Update main values
            document.getElementById('pressure1Value').textContent = currentData.pressure1.toFixed(2);
            document.getElementById('pressure2Value').textContent = currentData.pressure2.toFixed(2);
            document.getElementById('diffPressureValue').textContent = currentData.diffPressure.toFixed(2);
            document.getElementById('flowRateValue').textContent = currentData.flowRate.toFixed(2);
            document.getElementById('reynoldsValue').textContent = Math.round(currentData.reynolds);
            
            // Update comparison values
            document.getElementById('compPressure1').textContent = currentData.pressure1.toFixed(2);
            document.getElementById('compPressure2').textContent = currentData.pressure2.toFixed(2);
            document.getElementById('pressureDiffText').textContent = currentData.diffPressure.toFixed(2) + " Pa";
            
            // Update gauge values
            document.getElementById('gaugeFlowValue').textContent = currentData.flowRate.toFixed(2);
            document.getElementById('efficiencyValue').textContent = currentData.efficiency;
            
            // Update flow type text based on Reynolds number
            const flowTypeElement = document.getElementById('flowTypeText');
            if (currentData.reynolds < 2000) {
                flowTypeElement.textContent = "Laminar Flow";
                document.getElementById('flowTypeStatus').className = "status-indicator normal";
            } else if (currentData.reynolds < 4000) {
                flowTypeElement.textContent = "Transitional Flow";
                document.getElementById('flowTypeStatus').className = "status-indicator warning";
            } else {
                flowTypeElement.textContent = "Turbulent Flow";
                document.getElementById('flowTypeStatus').className = "status-indicator info";
            }
            
            // Update system status
            document.getElementById('uptime').textContent = currentData.uptime;
            document.getElementById('sampleCount').textContent = currentData.sampleCount;
            
            // Update configuration
            document.getElementById('venturiType').textContent = config.venturiType;
            document.getElementById('mainDiameter').textContent = config.mainDiameter.toFixed(1) + " mm";
            document.getElementById('throatDiameter').textContent = config.throatDiameter.toFixed(1) + " mm";
            document.getElementById('areaRatio').textContent = config.areaRatio.toFixed(2);
            
            // Update last update time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = timeString;
            document.getElementById('footerLastUpdate').textContent = timeString;
            document.getElementById('lastDataTime').textContent = timeString;
        }
        
        // Update all charts
        function updateAllCharts() {
            updateChart(pressure1Chart, dataHistory.pressure1);
            updateChart(pressure2Chart, dataHistory.pressure2);
            updateChart(diffPressureChart, dataHistory.diffPressure);
            updateChart(flowRateChart, dataHistory.flowRate);
            updateChart(reynoldsChart, dataHistory.reynolds);
            
            updateCompChart(pressureCompChart, dataHistory.pressure1, dataHistory.pressure2);
            
            // Calculate percentage for flow gauge (assuming max is 10 L/min)
            const flowPercentage = Math.min(currentData.flowRate / 10 * 100, 100);
            updateGauge(flowGauge, flowPercentage);
            
            // Update efficiency gauge
            updateGauge(efficiencyGauge, currentData.efficiency);
        }

        // Fetch data from API endpoint
        async function fetchData() {
            try {
                // Show loading state
                document.getElementById('refreshIcon').innerHTML = '<div class="loader"></div>';
                
                // Fetch data from GitHub Pages JSON file
                const response = await fetch('/flowsense/venturi_data.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                
                const data = await response.json();
                
                // Process the data
                processData(data);
                
                // Reset refresh button
                document.getElementById('refreshIcon').innerHTML = '↻';
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to fetch data. Using sample data instead.');
                
                // Use sample data instead
                useSampleData();
                
                // Reset refresh button
                document.getElementById('refreshIcon').innerHTML = '↻';
            }
        }
        
        // Process the fetched data
        function processData(data) {
            // Extract the latest data point
            const latestData = data.readings[data.readings.length - 1];
            
            // Update current values
            currentData = {
                pressure1: parseFloat(latestData.pressure1),
                pressure2: parseFloat(latestData.pressure2),
                diffPressure: parseFloat(latestData.pressureDiff),
                flowRate: parseFloat(latestData.flowRate),
                reynolds: calculateReynolds(parseFloat(latestData.flowRate)),
                efficiency: calculateEfficiency(parseFloat(latestData.pressure1), parseFloat(latestData.pressure2)),
                uptime: data.uptime || 0,
                sampleCount: data.readings.length
            };
            
            // Extract history for charts (last 10 readings or all if less than 10)
            const historyLength = Math.min(data.readings.length, 10);
            const historyData = data.readings.slice(-historyLength);
            
            dataHistory = {
                pressure1: historyData.map(item => parseFloat(item.pressure1)),
                pressure2: historyData.map(item => parseFloat(item.pressure2)),
                diffPressure: historyData.map(item => parseFloat(item.pressureDiff)),
                flowRate: historyData.map(item => parseFloat(item.flowRate)),
                reynolds: historyData.map(item => calculateReynolds(parseFloat(item.flowRate)))
            };
            
            // Update configuration if available
            if (data.config) {
                config.venturiType = data.config.venturiType || config.venturiType;
                config.mainDiameter = data.config.mainDiameter || config.mainDiameter;
                config.throatDiameter = data.config.throatDiameter || config.throatDiameter;
                config.areaRatio = (config.mainDiameter / config.throatDiameter) ** 2;
            }
            
            // Update UI
            updateDisplayedValues();
            updateAllCharts();
        }
        
        // Calculate Reynolds number based on flow rate
        function calculateReynolds(flowRate) {
            // Constants for water at room temperature
            const density = 998; // kg/m³
            const viscosity = 0.001; // Pa·s
            const diameter = config.throatDiameter / 1000; // Convert mm to m
            
            // Convert flow rate from L/min to m³/s
            const flowRateM3S = flowRate / (60 * 1000);
            
            // Calculate velocity in throat
            const area = Math.PI * (diameter/2) ** 2;
            const velocity = flowRateM3S / area;
            
            // Calculate Reynolds number
            return (density * velocity * diameter) / viscosity;
        }
        
        // Calculate venturi efficiency based on pressure recovery
        function calculateEfficiency(p1, p2) {
            // Theoretical efficiency calculation
            // This is a simplified model - in a real system you would use pressure recovery
            const beta = config.throatDiameter / config.mainDiameter;
            const theoreticalEfficiency = 98 - 2 * (1 - beta);
            
            // Add some random variation for demonstration
            const variation = Math.sin(Date.now() / 10000) * 5;
            return Math.round(theoreticalEfficiency + variation);
        }
        
        // Use sample data for demonstration
        function useSampleData() {
            // Update UI with sample data
            updateDisplayedValues();
            updateAllCharts();
        }

        // Initialize on page load
        window.onload = function() {
            initCharts();
            useSampleData(); // Start with sample data
            fetchData(); // Then try to fetch real data
            
            // Set up auto-refresh every 30 seconds
            setInterval(fetchData, 30000);
        };
    </script>
    <script>
      // Register service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/flowsense/sw.js')
            .then(registration => {
              console.log('ServiceWorker registration successful');
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    
      // Check for updates when coming back online
      window.addEventListener('online', () => {
        fetchData(); // Your existing fetchData function
      });
    </script>
    <script>
        // Modal functionality
        const modalOverlay = document.getElementById('modalOverlay');
        const infoModal = document.getElementById('infoModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalClose = document.getElementById('modalClose');
        const modalDragHandle = document.querySelector('.modal-drag-handle');
        const modalHeader = document.querySelector('.modal-header');
        
        // Chart information content
        const chartInfo = {
            pressure1: {
                title: "Pressure 1 Information",
                content: `
                    <p>This chart shows the pressure readings from Sensor 1 in Pascals (Pa).</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>The Y-axis shows the pressure value</li>
                        <li>The X-axis shows the most recent 10 readings</li>
                        <li>A stable line indicates consistent pressure</li>
                        <li>Fluctuations may indicate system changes or issues</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically between 90-110 Pa for this system</p>
                `
            },
            pressure2: {
                title: "Pressure 2 Information",
                content: `
                    <p>This chart shows the pressure readings from Sensor 2 in Pascals (Pa).</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>The Y-axis shows the pressure value</li>
                        <li>The X-axis shows the most recent 10 readings</li>
                        <li>This sensor should show lower pressure than Sensor 1</li>
                        <li>Compare with Pressure 1 to see the differential</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically between 75-85 Pa for this system</p>
                `
            },
            diffPressure: {
                title: "Differential Pressure Information",
                content: `
                    <p>This chart shows the difference between Pressure 1 and Pressure 2.</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>Calculated as Pressure 1 minus Pressure 2</li>
                        <li>Directly relates to flow rate through the Venturi</li>
                        <li>Larger differences indicate higher flow rates</li>
                        <li>Sudden drops may indicate blockages</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically between 15-25 Pa for normal operation</p>
                `
            },
            flowRate: {
                title: "Flow Rate Information",
                content: `
                    <p>This chart shows the calculated flow rate in liters per minute (L/min).</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>Calculated from the differential pressure</li>
                        <li>Follows the square root of the pressure difference</li>
                        <li>Higher values indicate more fluid moving through</li>
                        <li>Zero flow shows when system is off</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically between 2-5 L/min for normal operation</p>
                `
            },
            pressureComp: {
                title: "Pressure Comparison Information",
                content: `
                    <p>This chart compares both pressure sensors simultaneously.</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>Blue line shows Pressure 1 (upstream)</li>
                        <li>Green line shows Pressure 2 (throat)</li>
                        <li>The gap between lines represents differential pressure</li>
                        <li>Both should move somewhat in sync</li>
                    </ul>
                    <p><strong>Note:</strong> Pressure 2 should always be lower than Pressure 1 in a Venturi system.</p>
                `
            },
            flowGauge: {
                title: "Flow Rate Gauge Information",
                content: `
                    <p>This gauge provides a visual representation of the current flow rate.</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>The needle position shows current flow rate</li>
                        <li>Green indicates normal operating range</li>
                        <li>Approaching max may indicate high flow conditions</li>
                        <li>Min and max values are shown below</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically in the middle range (30-70%) during normal operation</p>
                `
            },
            efficiency: {
                title: "Venturi Efficiency Information",
                content: `
                    <p>This gauge shows the calculated efficiency of the Venturi meter.</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>Percentage of pressure recovered after the throat</li>
                        <li>Higher values indicate better efficiency</li>
                        <li>Efficiency depends on design and flow conditions</li>
                        <li>Below 70% may indicate issues</li>
                    </ul>
                    <p><strong>Normal Range:</strong> Typically 75-95% for well-designed Venturi meters</p>
                `
            },
            reynolds: {
                title: "Reynolds Number Information",
                content: `
                    <p>This chart shows the Reynolds number, indicating flow regime.</p>
                    <p><strong>How to read:</strong></p>
                    <ul>
                        <li>Below 2000: Laminar flow (smooth)</li>
                        <li>2000-4000: Transitional flow</li>
                        <li>Above 4000: Turbulent flow</li>
                        <li>Venturi meters work best in turbulent flow</li>
                    </ul>
                    <p><strong>Note:</strong> Calculated using throat diameter and current flow rate.</p>
                `
            }
        };
        
        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Add info buttons to each card
            document.querySelectorAll('.card').forEach(card => {
                // Skip system status and configuration cards
                if (!card.querySelector('.chart-container') && !card.querySelector('.chart-dual') && !card.querySelector('.gauge-container')) {
                    return;
                }
                
                const cardTitle = card.querySelector('.card-title').textContent;
                let chartType = '';
                
                if (cardTitle.includes('Pressure 1')) chartType = 'pressure1';
                else if (cardTitle.includes('Pressure 2')) chartType = 'pressure2';
                else if (cardTitle.includes('Differential')) chartType = 'diffPressure';
                else if (cardTitle.includes('Flow Rate') && !cardTitle.includes('Gauge')) chartType = 'flowRate';
                else if (cardTitle.includes('Comparison')) chartType = 'pressureComp';
                else if (cardTitle.includes('Gauge')) chartType = 'flowGauge';
                else if (cardTitle.includes('Efficiency')) chartType = 'efficiency';
                else if (cardTitle.includes('Reynolds')) chartType = 'reynolds';
                
                if (chartType) {
                    const infoButton = document.createElement('button');
                    infoButton.className = 'card-info-button';
                    infoButton.innerHTML = 'i';
                    infoButton.addEventListener('click', () => openModal(chartType));
                    card.style.position = 'relative';
                    card.appendChild(infoButton);
                }
            });
        });
        
        // Open modal with specific content
        function openModal(chartType) {
            const info = chartInfo[chartType];
            if (!info) return;
            
            modalTitle.textContent = info.title;
            modalContent.innerHTML = info.content;
            
            modalOverlay.classList.add('active');
            infoModal.classList.add('active');
            
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }
        
        // Close modal
        function closeModal() {
            modalOverlay.classList.remove('active');
            infoModal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Reset any transform applied during dragging
            infoModal.style.transform = '';
            
            // Reset transform based on screen size
            if (window.innerWidth >= 768) {
                infoModal.style.transform = 'translate(-50%, -50%) scale(0.9)';
            } else {
                infoModal.style.transform = 'translateX(-50%) translateY(100%)';
            }
        }
        
        // Event listeners
        modalOverlay.addEventListener('click', closeModal);
        modalClose.addEventListener('click', closeModal);
        
        // Swipe to close functionality for mobile
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        
        // Enable drag on both the handle and the header
        [modalDragHandle, modalHeader].forEach(element => {
            // Touch events for mobile
            element.addEventListener('touchstart', handleDragStart, { passive: false });
            
            // Mouse events for desktop (optional)
            element.addEventListener('mousedown', handleMouseDragStart);
        });
        
        function handleDragStart(e) {
            startY = e.touches[0].clientY;
            currentY = startY;
            isDragging = true;
            e.preventDefault();
        }
        
        function handleMouseDragStart(e) {
            startY = e.clientY;
            currentY = startY;
            isDragging = true;
            
            // Add mouse move and up events only when needed
            window.addEventListener('mousemove', handleMouseDragMove);
            window.addEventListener('mouseup', handleMouseDragEnd);
            
            e.preventDefault();
        }
        
        window.addEventListener('touchmove', handleDragMove, { passive: false });
        
        function handleDragMove(e) {
            if (!isDragging) return;
            
            // Only process for mobile view
            if (window.innerWidth >= 768) return;
            
            currentY = e.touches[0].clientY;
            
            // Calculate how much the modal has been dragged down
            const deltaY = currentY - startY;
            
            // Only move the modal down if dragging down
            if (deltaY > 0) {
                infoModal.style.transform = `translateX(-50%) translateY(${deltaY}px)`;
            }
            
            e.preventDefault();
        }
        
        function handleMouseDragMove(e) {
            if (!isDragging) return;
            
            // Only process for mobile view
            if (window.innerWidth >= 768) return;
            
            currentY = e.clientY;
            
            // Calculate how much the modal has been dragged down
            const deltaY = currentY - startY;
            
            // Only move the modal down if dragging down
            if (deltaY > 0) {
                infoModal.style.transform = `translateX(-50%) translateY(${deltaY}px)`;
            }
        }
        
        window.addEventListener('touchend', handleDragEnd);
        
        function handleDragEnd() {
            if (!isDragging) return;
            isDragging = false;
            
            // Calculate how much the modal has been dragged down
            const deltaY = currentY - startY;
            
            // If dragged enough, close the modal
            if (deltaY > 100) {
                closeModal();
            } else {
                // Otherwise, snap back to open position
                infoModal.style.transform = 'translateX(-50%) translateY(0)';
            }
        }
        
        function handleMouseDragEnd() {
            if (!isDragging) return;
            isDragging = false;
            
            // Remove event listeners
            window.removeEventListener('mousemove', handleMouseDragMove);
            window.removeEventListener('mouseup', handleMouseDragEnd);
            
            // Calculate how much the modal has been dragged down
            const deltaY = currentY - startY;
            
            // If dragged enough, close the modal
            if (deltaY > 100) {
                closeModal();
            } else {
                // Otherwise, snap back to open position
                infoModal.style.transform = 'translateX(-50%) translateY(0)';
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            // Update modal position based on screen size if the modal is active
            if (infoModal.classList.contains('active')) {
                if (window.innerWidth >= 768) {
                    infoModal.style.transform = 'translate(-50%, -50%) scale(1)';
                } else {
                    infoModal.style.transform = 'translateX(-50%) translateY(0)';
                }
            }
        });
    </script>
</body>
</html>
